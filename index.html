<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cofre Legendario</title>
    <link href="https://fonts.googleapis.com/css2?family=Lilita+One&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Lilita One', cursive;
            overflow: hidden;
            background: #1a0a2e;
        }

        .game-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('./assets/fondo.jpg');
            background-position: center center;
            background-size: cover;
            background-repeat: no-repeat;
            z-index: 0;
        }

        .container {
            text-align: center;
            position: relative;
            z-index: 10;
            width: 100%;
            max-width: 400px;
            padding: 20px;
        }

        /* Logo */
        .cr-logo {
            position: fixed;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            width: clamp(216px, 60vw, 300px);
            height: auto;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5));
            animation: logo-float 4s ease-in-out infinite;
            z-index: 15;
        }

        @keyframes logo-float {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-8px); }
        }

        /* Cofre cerrado */
        .chest-area {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 350px;
        }

        .chest-wrapper {
            position: relative;
            cursor: pointer;
            z-index: 5;
        }

        .chest-wrapper:active {
            transform: scale(0.95);
        }

        .chest-wrapper:active .chest-img {
            animation: none;
        }

        .chest-img {
            width: clamp(200px, 55vw, 280px);
            height: auto;
            animation: chest-glow-breathe 2.5s ease-in-out infinite;
        }

        @keyframes chest-glow-breathe {
            0%, 100% {
                filter:
                    drop-shadow(0 0 8px rgba(168, 85, 247, 0.5))
                    drop-shadow(0 0 15px rgba(168, 85, 247, 0.3))
                    drop-shadow(0 10px 20px rgba(0,0,0,0.5));
                transform: translateY(0);
            }
            50% {
                filter:
                    drop-shadow(0 0 20px rgba(168, 85, 247, 0.8))
                    drop-shadow(0 0 40px rgba(168, 85, 247, 0.5))
                    drop-shadow(0 0 60px rgba(168, 85, 247, 0.3))
                    drop-shadow(0 10px 20px rgba(0,0,0,0.5));
                transform: translateY(-6px);
            }
        }

        .chest-wrapper.opened {
            animation: chest-open 0.6s forwards;
        }

        @keyframes chest-open {
            0% { transform: scale(1); }
            30% { transform: scale(1.15) rotate(-5deg); }
            60% { transform: scale(1.25) rotate(5deg); }
            100% { transform: scale(1.4); opacity: 0; }
        }

        /* Rayos de luz al abrir */
        .light-burst {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(168, 85, 247, 0.95) 0%, transparent 60%);
            opacity: 0;
            pointer-events: none;
            z-index: 50;
        }

        .light-burst.active {
            animation: burst 0.8s forwards;
        }

        @keyframes burst {
            0% { opacity: 0; transform: scale(0.5); }
            50% { opacity: 1; }
            100% { opacity: 0; transform: scale(2.5); }
        }

        /* PartÃ­culas */
        .particles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 55;
            overflow: hidden;
        }

        .legendary-particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #a855f7;
            border-radius: 50%;
            box-shadow: 0 0 15px #a855f7, 0 0 30px #a855f7;
        }

        /* CARTA LEGENDARIA */
        .card-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.92);
            display: none;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            z-index: 100;
            padding: 20px;
            padding-top: 8%;
        }

        .card-overlay.show {
            display: flex;
            animation: overlay-in 0.3s forwards;
        }

        @keyframes overlay-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Pregunta arriba */
        .card-question-top {
            color: #fff;
            font-size: clamp(20px, 5.5vw, 28px);
            text-shadow:
                0 0 20px rgba(168, 85, 247, 0.8),
                0 2px 0 #1a1209,
                0 4px 10px rgba(0,0,0,0.8);
            line-height: 1.3;
            margin-bottom: 15px;
            text-align: center;
            opacity: 0;
            animation: question-appear 0.5s 0.8s forwards;
        }

        @keyframes question-appear {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Contenedor carta */
        .card-scene {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            width: 100%;
        }

        /* Carta hexagonal */
        .hex-card {
            width: clamp(140px, 38vw, 180px);
            height: clamp(200px, 55vw, 260px);
            position: relative;
            z-index: 10;
            transform: scale(0) translateY(100px);
            animation: card-float-up 0.8s 0.3s forwards;
        }

        @keyframes card-float-up {
            0% { transform: scale(0) translateY(100px); opacity: 0; }
            60% { transform: scale(1.1) translateY(-10px); opacity: 1; }
            80% { transform: scale(0.95) translateY(0); }
            100% { transform: scale(1) translateY(0); }
        }

        .hex-card-inner {
            width: 100%;
            height: 100%;
            clip-path: polygon(50% 0%, 100% 12%, 100% 88%, 50% 100%, 0% 88%, 0% 12%);
            position: relative;
            animation: card-glow-pulse 2s ease-in-out infinite;
        }

        @keyframes card-glow-pulse {
            0%, 100% {
                filter: drop-shadow(0 0 15px rgba(168, 85, 247, 0.7))
                        drop-shadow(0 0 30px rgba(168, 85, 247, 0.5));
            }
            50% {
                filter: drop-shadow(0 0 25px rgba(168, 85, 247, 1))
                        drop-shadow(0 0 50px rgba(168, 85, 247, 0.7))
                        drop-shadow(0 0 80px rgba(168, 85, 247, 0.4));
            }
        }

        /* Borde metÃ¡lico grueso */
        .hex-border {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            clip-path: polygon(50% 0%, 100% 12%, 100% 88%, 50% 100%, 0% 88%, 0% 12%);
            background: linear-gradient(
                160deg,
                #f0f0f0 0%,
                #e0e0e0 5%,
                #c0c0c0 15%,
                #a8a8a8 25%,
                #d8d8d8 35%,
                #909090 50%,
                #b8b8b8 65%,
                #808080 75%,
                #a0a0a0 85%,
                #c8c8c8 95%,
                #e8e8e8 100%
            );
        }

        .hex-border::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                135deg,
                rgba(255,255,255,0.6) 0%,
                rgba(255,255,255,0.2) 25%,
                transparent 50%,
                rgba(0,0,0,0.1) 75%,
                rgba(0,0,0,0.2) 100%
            );
            clip-path: polygon(50% 0%, 100% 12%, 100% 88%, 50% 100%, 0% 88%, 0% 12%);
        }

        /* Fondo hielo */
        .hex-content {
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            bottom: 8px;
            clip-path: polygon(50% 0%, 100% 12%, 100% 88%, 50% 100%, 0% 88%, 0% 12%);
            background: linear-gradient(
                180deg,
                rgba(255, 255, 255, 0.4) 0%,
                rgba(220, 240, 255, 0.3) 20%,
                rgba(200, 220, 255, 0.25) 40%,
                rgba(180, 130, 200, 0.35) 60%,
                rgba(200, 100, 180, 0.45) 80%,
                rgba(220, 80, 160, 0.55) 100%
            );
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .hex-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 40%;
            background: linear-gradient(
                180deg,
                rgba(255, 255, 255, 0.6) 0%,
                rgba(255, 255, 255, 0.3) 50%,
                transparent 100%
            );
        }

        .hex-content::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60%;
            background: radial-gradient(
                ellipse at center bottom,
                rgba(236, 72, 153, 0.6) 0%,
                rgba(168, 85, 247, 0.4) 40%,
                transparent 70%
            );
        }

        /* Signo de interrogaciÃ³n grande */
        .hex-question-mark {
            font-size: clamp(70px, 20vw, 100px);
            color: #fff;
            text-shadow:
                0 0 20px rgba(236, 72, 153, 1),
                0 0 40px rgba(168, 85, 247, 0.8),
                0 0 60px rgba(168, 85, 247, 0.5),
                0 3px 0 rgba(0,0,0,0.4);
            z-index: 10;
            animation: question-pulse 1.5s ease-in-out infinite;
        }

        @keyframes question-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        /* Sparkles */
        .hex-sparkles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 15;
        }

        .sparkle {
            position: absolute;
            font-size: 14px;
            animation: sparkle-float 2s ease-in-out infinite;
        }

        @keyframes sparkle-float {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        /* Botones SÃ­/No */
        .buttons-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            opacity: 0;
            animation: buttons-appear 0.5s 1s forwards;
        }

        @keyframes buttons-appear {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .choice-btn {
            padding: 14px 35px;
            font-family: 'Lilita One', cursive;
            font-size: clamp(18px, 5vw, 24px);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            overflow: hidden;
        }

        .btn-yes {
            background: linear-gradient(180deg, #4ade80 0%, #22c55e 50%, #16a34a 100%);
            color: #fff;
            box-shadow: 0 5px 0 #15803d, 0 8px 15px rgba(0,0,0,0.4);
            text-shadow: 0 2px 0 #15803d;
        }

        .btn-yes::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 4px;
            right: 4px;
            height: 40%;
            background: linear-gradient(180deg, rgba(255,255,255,0.4) 0%, transparent 100%);
            border-radius: 10px 10px 50% 50%;
        }

        .btn-yes:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 #15803d, 0 4px 10px rgba(0,0,0,0.4);
        }

        .btn-no {
            background: linear-gradient(180deg, #f87171 0%, #ef4444 50%, #dc2626 100%);
            color: #fff;
            box-shadow: 0 5px 0 #b91c1c, 0 8px 15px rgba(0,0,0,0.4);
            text-shadow: 0 2px 0 #b91c1c;
        }

        .btn-no::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 4px;
            right: 4px;
            height: 40%;
            background: linear-gradient(180deg, rgba(255,255,255,0.4) 0%, transparent 100%);
            border-radius: 10px 10px 50% 50%;
        }

        .btn-no:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 #b91c1c, 0 4px 10px rgba(0,0,0,0.4);
        }

        /* Cofre abierto grande abajo */
        .card-chest {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: clamp(200px, 55vw, 300px);
            height: auto;
            filter: drop-shadow(0 -10px 30px rgba(168, 85, 247, 0.5));
            opacity: 0;
            animation: chest-appear 0.5s 0.5s forwards;
            z-index: 5;
        }

        @keyframes chest-appear {
            from { opacity: 0; transform: translateX(-50%) scale(0.8) translateY(50px); }
            to { opacity: 1; transform: translateX(-50%) scale(1) translateY(0); }
        }

        /* Brillo del cofre */
        .chest-light {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 300px;
            background: linear-gradient(
                to top,
                rgba(168, 85, 247, 0.7) 0%,
                rgba(168, 85, 247, 0.4) 30%,
                rgba(168, 85, 247, 0.1) 60%,
                transparent 100%
            );
            clip-path: polygon(25% 100%, 75% 100%, 95% 0%, 5% 0%);
            opacity: 0;
            animation: light-beam 0.5s 0.4s forwards;
            z-index: 1;
        }

        @keyframes light-beam {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* PANTALLA BOMBA */
        .bomb-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 150;
            padding: 20px;
        }

        .bomb-overlay.show {
            display: flex;
            animation: overlay-in 0.3s forwards;
        }

        .bomb-icon {
            font-size: 80px;
            animation: bomb-shake 0.5s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes bomb-shake {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }

        .bomb-timer {
            font-size: clamp(40px, 12vw, 60px);
            color: #ef4444;
            text-shadow: 0 0 20px #ef4444, 0 0 40px #ef4444;
            margin-bottom: 20px;
            font-variant-numeric: tabular-nums;
        }

        .bomb-question {
            color: #fff;
            font-size: clamp(16px, 4.5vw, 22px);
            text-align: center;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .bomb-problem {
            color: #fbbf24;
            font-size: clamp(24px, 7vw, 36px);
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
        }

        .bomb-input {
            width: 200px;
            padding: 15px;
            font-size: 24px;
            font-family: 'Lilita One', cursive;
            text-align: center;
            border: 3px solid #ef4444;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            margin-bottom: 20px;
        }

        .bomb-input:focus {
            outline: none;
            border-color: #fbbf24;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
        }

        .bomb-escape-btn {
            padding: 10px 20px;
            font-family: 'Lilita One', cursive;
            font-size: 14px;
            background: linear-gradient(180deg, #4ade80 0%, #22c55e 100%);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
            box-shadow: 0 3px 0 #15803d;
        }

        .bomb-escape-btn:active {
            transform: translateY(2px);
            box-shadow: 0 1px 0 #15803d;
        }

        /* ExplosiÃ³n */
        .explosion-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }

        .explosion-overlay.show {
            display: flex;
        }

        .explosion-overlay.explode {
            animation: explosion-flash 0.5s forwards;
        }

        @keyframes explosion-flash {
            0% { background: #fff; }
            20% { background: #ff6600; }
            40% { background: #ff0000; }
            60% { background: #660000; }
            100% { background: #000; }
        }

        .explosion-text {
            color: #ef4444;
            font-size: clamp(30px, 10vw, 50px);
            text-shadow: 0 0 30px #ef4444;
            text-align: center;
        }

        /* Pantalla adiÃ³s */
        .goodbye-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }

        .goodbye-overlay.show {
            display: flex;
            animation: fade-in 1s forwards;
        }

        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .goodbye-text {
            color: #fff;
            font-size: clamp(40px, 12vw, 60px);
            text-shadow: 0 0 20px rgba(255,255,255,0.3);
        }

        /* Pantalla de Ã©xito */
        .success-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('./assets/fondo.jpg');
            background-position: center center;
            background-size: cover;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 200;
            padding: 20px;
        }

        .success-overlay::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, rgba(236, 72, 153, 0.35) 0%, rgba(0,0,0,0.65) 100%);
        }

        .success-overlay.show {
            display: flex;
            animation: success-in 0.5s forwards;
        }

        @keyframes success-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .success-content {
            position: relative;
            z-index: 10;
            text-align: center;
        }

        .success-characters {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 15px;
            margin-bottom: 35px;
        }

        .success-char {
            width: clamp(110px, 30vw, 160px);
            height: auto;
            filter: drop-shadow(0 15px 25px rgba(0,0,0,0.6));
        }

        .char-left {
            animation: char-bounce-left 2s ease-in-out infinite;
        }

        .char-right {
            animation: char-bounce-right 2s ease-in-out infinite 0.5s;
        }

        @keyframes char-bounce-left {
            0%, 100% { transform: translateY(0) rotate(-5deg); }
            50% { transform: translateY(-25px) rotate(5deg); }
        }

        @keyframes char-bounce-right {
            0%, 100% { transform: translateY(0) rotate(5deg); }
            50% { transform: translateY(-25px) rotate(-5deg); }
        }

        .success-heart {
            font-size: clamp(60px, 18vw, 100px);
            animation: heart-mega-beat 0.8s ease-in-out infinite;
            filter: drop-shadow(0 0 30px rgba(236, 72, 153, 0.9));
        }

        @keyframes heart-mega-beat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.25); }
        }

        .success-banner {
            background: linear-gradient(180deg, #ec4899 0%, #db2777 50%, #be185d 100%);
            padding: 22px 45px;
            border-radius: 18px;
            border: 5px solid #9d174d;
            box-shadow:
                0 10px 0 #831843,
                0 15px 40px rgba(0,0,0,0.6),
                inset 0 2px 0 rgba(255,255,255,0.35);
            position: relative;
        }

        .success-banner::before {
            content: '';
            position: absolute;
            top: 4px;
            left: 12px;
            right: 12px;
            height: 40%;
            background: linear-gradient(180deg, rgba(255,255,255,0.35) 0%, transparent 100%);
            border-radius: 14px;
        }

        .success-text {
            color: #fff;
            font-size: clamp(30px, 9vw, 48px);
            text-shadow:
                0 3px 0 #9d174d,
                0 5px 15px rgba(0,0,0,0.5);
            letter-spacing: 2px;
        }

        /* Confeti */
        .confetti-piece {
            position: fixed;
            top: -20px;
            z-index: 250;
            pointer-events: none;
        }

        .confetti-piece.heart {
            font-size: 24px;
            animation: confetti-heart-fall linear forwards;
        }

        @keyframes confetti-heart-fall {
            to {
                top: 110vh;
                transform: rotate(720deg) scale(0.5);
            }
        }

        .confetti-piece.square {
            width: 14px;
            height: 14px;
            animation: confetti-square-fall linear forwards;
        }

        @keyframes confetti-square-fall {
            to {
                top: 110vh;
                transform: rotate(1080deg);
            }
        }

        .hidden-section {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="game-background"></div>

    <!-- Pantalla del cofre -->
    <div class="container" id="chestScreen">
        <img src="./assets/clash_royale_logo.webp" alt="Clash Royale" class="cr-logo">
        <div class="chest-area">
            <div class="chest-wrapper" id="chestWrapper" onclick="openChest()">
                <img src="./assets/cofre.png" alt="Cofre" class="chest-img" id="chestImg">
            </div>
        </div>
    </div>

    <div class="light-burst" id="lightBurst"></div>
    <div class="particles-container" id="particlesContainer"></div>

    <!-- Carta -->
    <div class="card-overlay" id="cardOverlay">
        <div class="card-question-top">Â¿Quieres ser mi San ValentÃ­n?</div>

        <div class="card-scene">
            <div class="hex-card">
                <div class="hex-card-inner">
                    <div class="hex-border"></div>
                    <div class="hex-content">
                        <div class="hex-question-mark">?</div>
                        <div class="hex-sparkles" id="sparklesContainer"></div>
                    </div>
                </div>
            </div>

            <div class="buttons-container">
                <button class="choice-btn btn-yes" onclick="sayYes()">SÃ­</button>
                <button class="choice-btn btn-no" onclick="sayNo()">No</button>
            </div>

            <div class="chest-light"></div>
            <img src="./assets/cofre_abierto.png" alt="Cofre" class="card-chest">
        </div>
    </div>

    <!-- Pantalla bomba -->
    <div class="bomb-overlay" id="bombOverlay">
        <div class="bomb-icon">ðŸ’£</div>
        <div class="bomb-timer" id="bombTimer">1:00</div>
        <div class="bomb-question">Â¿CuÃ¡l es la respuesta para desactivar la bomba?</div>
        <div class="bomb-problem">âˆš625 + 17 Ã— 3 = ?</div>
        <input type="number" class="bomb-input" id="bombInput" placeholder="???">
        <button class="bomb-escape-btn" onclick="sayYes()">SÃ­, sÃ© mi San ValentÃ­n</button>
    </div>

    <!-- Pantalla explosiÃ³n -->
    <div class="explosion-overlay" id="explosionOverlay">
        <div class="explosion-text">ðŸ’¥ Â¡TE LO PIERDES! ðŸ’¥</div>
    </div>

    <!-- Pantalla adiÃ³s -->
    <div class="goodbye-overlay" id="goodbyeOverlay">
        <div class="goodbye-text">Â¡AdiÃ³s!</div>
    </div>

    <!-- Pantalla de Ã©xito -->
    <div class="success-overlay" id="successOverlay">
        <div class="success-content">
            <div class="success-characters">
                <img src="./assets/rey_esqueleto.webp" alt="Rey Esqueleto" class="success-char char-left">
                <div class="success-heart">ðŸ’–</div>
                <img src="./assets/bruja.webp" alt="Bruja" class="success-char char-right">
            </div>
            <div class="success-banner">
                <div class="success-text">Â¡Te amo Gusita!</div>
            </div>
        </div>
    </div>

    <!-- Audio elementos -->
    <audio id="menuMusic" src="./sounds/clash_royale_menu.mp3" preload="auto"></audio>
    <audio id="successMusic" src="./sounds/howls_moving_castle.mp3" preload="auto"></audio>
    <audio id="deathMusic" src="./sounds/muerte_s_bita.mp3" preload="auto"></audio>

    <script>
        let chestOpened = false;
        let bombTimer = null;
        let timeLeft = 60;
        const CORRECT_ANSWER = 76; // âˆš625 = 25, 17Ã—3 = 51, 25+51 = 76

        // Sistema de audio con crossfade
        const audioSystem = {
            currentAudio: null,
            fadeInterval: null,
            loopTimeout: null,

            // DuraciÃ³n del fade en ms
            fadeDuration: 1500,
            maxVolume: 0.8,

            play(audioId) {
                const newAudio = document.getElementById(audioId);
                if (!newAudio) return;

                // Si hay audio sonando, hacer fade out
                if (this.currentAudio && this.currentAudio !== newAudio) {
                    this.fadeOut(this.currentAudio);
                }

                // Limpiar loop anterior
                if (this.loopTimeout) {
                    clearTimeout(this.loopTimeout);
                }

                this.currentAudio = newAudio;
                newAudio.currentTime = 0;
                newAudio.volume = 0;
                newAudio.play().catch(() => {});

                // Fade in
                this.fadeIn(newAudio);

                // Configurar loop con crossfade
                this.setupLoop(newAudio);
            },

            fadeIn(audio) {
                let volume = 0;
                const step = this.maxVolume / (this.fadeDuration / 50);

                const fade = setInterval(() => {
                    volume += step;
                    if (volume >= this.maxVolume) {
                        audio.volume = this.maxVolume;
                        clearInterval(fade);
                    } else {
                        audio.volume = volume;
                    }
                }, 50);
            },

            fadeOut(audio) {
                let volume = audio.volume;
                const step = volume / (this.fadeDuration / 50);

                const fade = setInterval(() => {
                    volume -= step;
                    if (volume <= 0) {
                        audio.volume = 0;
                        audio.pause();
                        clearInterval(fade);
                    } else {
                        audio.volume = volume;
                    }
                }, 50);
            },

            setupLoop(audio) {
                // Calcular cuÃ¡ndo empezar el fade out antes de que termine
                const checkLoop = () => {
                    if (audio !== this.currentAudio) return;

                    const timeRemaining = audio.duration - audio.currentTime;

                    // Cuando queda poco tiempo, hacer crossfade
                    if (timeRemaining <= this.fadeDuration / 1000 + 0.1) {
                        // Fade out actual
                        let volume = audio.volume;
                        const fadeOutStep = volume / (this.fadeDuration / 50);

                        const fadeOutInterval = setInterval(() => {
                            volume -= fadeOutStep;
                            if (volume <= 0 || audio !== this.currentAudio) {
                                clearInterval(fadeOutInterval);
                            } else {
                                audio.volume = Math.max(0, volume);
                            }
                        }, 50);

                        // Reiniciar y fade in
                        setTimeout(() => {
                            if (audio !== this.currentAudio) return;
                            audio.currentTime = 0;
                            audio.volume = 0;
                            this.fadeIn(audio);
                            this.setupLoop(audio);
                        }, this.fadeDuration * 0.8);
                    } else {
                        this.loopTimeout = setTimeout(checkLoop, 100);
                    }
                };

                // Esperar a que el audio tenga duraciÃ³n vÃ¡lida
                if (audio.duration && !isNaN(audio.duration)) {
                    checkLoop();
                } else {
                    audio.addEventListener('loadedmetadata', () => checkLoop(), { once: true });
                }
            },

            stop() {
                if (this.loopTimeout) {
                    clearTimeout(this.loopTimeout);
                }
                if (this.currentAudio) {
                    this.fadeOut(this.currentAudio);
                    this.currentAudio = null;
                }
            }
        };

        // Iniciar mÃºsica del menÃº al primer toque
        let musicStarted = false;
        function startMenuMusic() {
            if (musicStarted) return;
            musicStarted = true;
            audioSystem.play('menuMusic');
        }

        function createCardSparkles() {
            const container = document.getElementById('sparklesContainer');
            if (!container) return;

            const positions = [
                {x: '15%', y: '20%'}, {x: '85%', y: '18%'},
                {x: '10%', y: '50%'}, {x: '90%', y: '45%'},
                {x: '20%', y: '75%'}, {x: '80%', y: '70%'}
            ];

            positions.forEach((pos, i) => {
                const sparkle = document.createElement('span');
                sparkle.className = 'sparkle';
                sparkle.textContent = 'âœ¨';
                sparkle.style.left = pos.x;
                sparkle.style.top = pos.y;
                sparkle.style.animationDelay = (i * 0.4) + 's';
                container.appendChild(sparkle);
            });
        }

        function createBurstParticles() {
            const container = document.getElementById('particlesContainer');
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;

            for (let i = 0; i < 40; i++) {
                const particle = document.createElement('div');
                particle.className = 'legendary-particle';

                const angle = (Math.PI * 2 * i) / 40;
                const velocity = 120 + Math.random() * 180;
                const endX = centerX + Math.cos(angle) * velocity;
                const endY = centerY + Math.sin(angle) * velocity;

                particle.style.left = centerX + 'px';
                particle.style.top = centerY + 'px';

                particle.animate([
                    { transform: 'translate(-50%, -50%) scale(1)', opacity: 1 },
                    { transform: `translate(${endX - centerX}px, ${endY - centerY}px) scale(0)`, opacity: 0 }
                ], {
                    duration: 900,
                    easing: 'cubic-bezier(0, 0.5, 0.5, 1)'
                });

                container.appendChild(particle);
                setTimeout(() => particle.remove(), 900);
            }
        }

        function openChest() {
            // Iniciar mÃºsica al tocar el cofre
            startMenuMusic();

            if (chestOpened) return;
            chestOpened = true;

            const wrapper = document.getElementById('chestWrapper');
            const chestImg = document.getElementById('chestImg');
            const lightBurst = document.getElementById('lightBurst');

            chestImg.src = './assets/cofre_abierto.png';
            wrapper.classList.add('opened');

            lightBurst.classList.add('active');
            createBurstParticles();

            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100]);
            }

            setTimeout(() => {
                document.getElementById('chestScreen').classList.add('hidden-section');
                document.getElementById('cardOverlay').classList.add('show');
            }, 900);
        }

        function sayYes() {
            if (bombTimer) {
                clearInterval(bombTimer);
                bombTimer = null;
            }

            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100, 50, 200]);
            }

            // Cambiar a mÃºsica de Ã©xito
            audioSystem.play('successMusic');

            document.getElementById('cardOverlay').classList.remove('show');
            document.getElementById('bombOverlay').classList.remove('show');
            document.getElementById('successOverlay').classList.add('show');
            startConfetti();
        }

        function sayNo() {
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200, 100, 400]);
            }

            // Cambiar a mÃºsica de muerte/bomba
            audioSystem.play('deathMusic');

            document.getElementById('cardOverlay').classList.remove('show');
            document.getElementById('bombOverlay').classList.add('show');
            startBombTimer();
        }

        function startBombTimer() {
            timeLeft = 60;
            updateTimerDisplay();

            const input = document.getElementById('bombInput');
            input.value = '';
            input.focus();

            input.addEventListener('input', checkAnswer);

            bombTimer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();

                if (timeLeft <= 0) {
                    clearInterval(bombTimer);
                    bombTimer = null;
                    triggerExplosion();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('bombTimer').textContent =
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function checkAnswer() {
            const input = document.getElementById('bombInput');
            const answer = parseInt(input.value);

            if (answer === CORRECT_ANSWER) {
                clearInterval(bombTimer);
                bombTimer = null;
                showGoodbye();
            }
        }

        function triggerExplosion() {
            const explosionOverlay = document.getElementById('explosionOverlay');
            document.getElementById('bombOverlay').classList.remove('show');
            explosionOverlay.classList.add('show');
            explosionOverlay.classList.add('explode');

            // Detener mÃºsica
            audioSystem.stop();

            if (navigator.vibrate) {
                navigator.vibrate([500, 100, 500, 100, 500]);
            }
        }

        function showGoodbye() {
            document.getElementById('bombOverlay').classList.remove('show');
            document.getElementById('goodbyeOverlay').classList.add('show');

            // Detener mÃºsica
            audioSystem.stop();
        }

        function startConfetti() {
            const colors = ['#ec4899', '#f43f5e', '#a855f7', '#fbbf24', '#22c55e', '#3b82f6'];
            const hearts = ['ðŸ’–', 'ðŸ’•', 'â¤ï¸', 'ðŸ’—', 'ðŸ’“', 'âœ¨'];

            function createConfettiPiece() {
                const piece = document.createElement('div');
                piece.className = 'confetti-piece';

                if (Math.random() > 0.35) {
                    piece.classList.add('heart');
                    piece.textContent = hearts[Math.floor(Math.random() * hearts.length)];
                    piece.style.fontSize = (18 + Math.random() * 22) + 'px';
                } else {
                    piece.classList.add('square');
                    piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '3px';
                }

                piece.style.left = Math.random() * 100 + '%';
                piece.style.animationDuration = (2 + Math.random() * 2) + 's';

                document.body.appendChild(piece);
                setTimeout(() => piece.remove(), 4000);
            }

            for (let i = 0; i < 80; i++) {
                setTimeout(createConfettiPiece, i * 25);
            }

            setInterval(() => {
                for (let i = 0; i < 4; i++) {
                    createConfettiPiece();
                }
            }, 250);
        }

        createCardSparkles();
    </script>
</body>
</html>
